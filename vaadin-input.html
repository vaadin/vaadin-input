<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<!--
`<vaadin-input>` is a Polymer element for input control in forms.

```html
<vaadin-input>
</vaadin-input>
```

### Styling
The following mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--vaadin-input__input` | Mixin applied to the input element | `{}`
`--vaadin-input__input-placeholder` | Mixin applied to the input's placeholder | `{}`

@element vaadin-input
@demo demo/index.html
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="vaadin-form-element-mixin.html">
<link rel="import" href="vaadin-control-state-mixin.html">

<dom-module id="vaadin-input">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      input {
        @apply --vaadin-input__input;
      }

      input::-webkit-input-placeholder {
        @apply --vaadin-input__input-placeholder;
      }

      input::-moz-placeholder {
        @apply --vaadin-input__input-placeholder;
      }

      input::placeholder {
        @apply --vaadin-input__input-placeholder;
      }
    </style>
    <input id="input"
      autocomplete$="[[autocomplete]]"
      autocorrect$="[[autocorrect]]"
      autofocus$="[[autofocus]]"
      disabled$="[[disabled]]"
      list="[[list]]"
      maxlength$="[[maxlength]]"
      minlength$="[[minlength]]"
      name="[[name]]"
      pattern="[[pattern]]"
      placeholder="[[placeholder]]"
      readonly$="[[readonly]]"
      required$="[[required]]"
      value="{{value::input}}"
      title="[[title]]"
      on-focus="_onInputFocus"
      on-blur="_onInputBlur"
      on-keydown="_onInputKeyDown"
    />
  </template>

  <script>
    class VaadinInput extends window.VaadinControlStateMixin(window.VaadinFormElementMixin(Polymer.Element)) {
      static get is() {
        return 'vaadin-input';
      }

      static get config() {
        return {
          properties: {
            /**
             * Whether the value of the control can be automatically completed by the browser.
             * List of available options at:
             * https://developer.mozilla.org/en/docs/Web/HTML/Element/input#attr-autocomplete
             */
            autocomplete: {
              type: String
            },

            /**
             * Specify that this control should have input focus when the page loads.
             */
            autofocus: {
              type: Boolean
            },

            /**
             * Identifies a list of pre-defined options to suggest to the user.
             * The value must be the id of a <datalist> element in the same document.
             */
            list: {
              type: String
            },

            /**
             * If the value of the type attribute is text, email, search, password, tel, or url,
             * specifies the maximum number of characters (in Unicode code points) that the user
             * can enter.
             */
            maxlength: {
              type: Number
            },
            /**
             * If the value of the type attribute is text, email, search, password, tel, or url,
             * specifies the minimum number of characters (in Unicode code points) that the user
             * can enter.
             */
            minlength: {
              type: Number
            },

            /**
             * The name of the control, which is submitted with the form data.
             */
            name: {
              type: String
            },

            /**
             * A regular expression that the value is checked against.
             * The pattern must match the entire value, not just some subset.
             * This attribute applies when the value of the type attribute is text, search, tel,
             * url, email, or password, otherwise it is ignored.
             */
            pattern: {
              type: String
            },

            /**
             * A hint to the user of what can be entered in the control.
             */
            placeholder: {
              type: String
            },

            /**
             * This attribute indicates that the user cannot modify the value of the control.
             */
            readonly: {
              type: Boolean
            },

            /**
             * Specifies that the user must fill in a value.
             */
            required: {
              type: Boolean
            },

            /**
             * Message to show to the user when validation fails.
             */
            title: {
              type: String
            },

            /**
             * The initial value of the control.
             * It can be used for two-way data binding.
             */
            value: {
              type: String,
              observer: '_valueChanged',
              notify: true
            },

            /**
             * This property is set to true when the control value invalid.
             */
            invalid: {
              type: Boolean,
              reflectToAttribute: true,
              notify: true
            },

            /**
             * A read-only property indicating whether this input has a non empty value.
             * It can be used for example in styling of the component.
             */
            hasValue: {
              type: Boolean,
              value: false,
              notify: true,
              readOnly: true,
              reflectToAttribute: true
            },

            /**
             * If true, the element currently has focus.
             */
            focused: {
              type: Boolean,
              notify: true,
              readOnly: true,
              reflectToAttribute: true,
              observer: '_focusedChanged'
            }
          }
        };
      }

      ready() {
        super.ready();

        // Make FF take the focus (#9)
        if (this.autofocus) {
          this.focus();
        }

        this.addEventListener('focus', this._focus.bind(this));
        this.addEventListener('blur', this._blur.bind(this));
      }

      _onInputFocus() {
        this._setFocused(true);
      }

      _focus() {
        this.$.input.focus();
      }

      _onInputBlur() {
        this._setFocused(false);
        this.invalid = this._isInvalid();
      }

      _blur() {
        this.$.input.blur();
      }

      _valueChanged(value) {
        if (this.invalid) {
          this.invalid = this._isInvalid();
        }
        this._setHasValue(value != null && value !== '');
      }

      _isInvalid() {
        return !this.validate();
      }

      /**
       * Returns true if `value` is valid.
       * `<iron-form>` uses this to check the validity or all its elements.
       *
       * @return {boolean} True if the value is valid.
       */
      validate() {
        return this.$.input.checkValidity();
      }

      _focusedChanged() {
        // Needed for Edge, until they have support for CSS Custom Properties
        // (already shipping in Edge Preview)
        this.updateStyles();
      }

      _disabledChanged(disabled) {
        if (disabled) {
          this._oldTabindex = this.tabindex;
          this.tabIndex = -1;
        } else {
          this.tabIndex = this._oldTabindex || 0;
          this._oldTabindex = undefined;
        }
      }

      _tabindexChanged(tabindex) {
        if (this.disabled && tabindex != -1) {
          this._oldTabindex = tabindex;
        }
        if (window.ShadyDOM && !this._tabindexChanging) {
          // In shady remove host attribute and set to internal input
          this._tabindexChanging = true;
          this.removeAttribute('tabindex');
          this.$.input.tabIndex = tabindex;
          this._tabindexChanging = undefined;
        }
      }

      _onInputKeyDown(e) {
        // on shift-tab
        if (e.shiftKey && e.keyCode === 9) {
          this.focus();
        }
      }
    }

    customElements.define(VaadinInput.is, VaadinInput);
  </script>
</dom-module>
