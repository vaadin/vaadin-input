<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-input tests</title>

  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../vaadin-input.html">
  <link rel="import" href="../../iron-form/iron-form.html">

</head>

<body>
  <test-fixture id="default">
    <template>
      <vaadin-input id="customElement"></vaadin-input>
    </template>
  </test-fixture>

  <script>

    function runAsync(test, done, timeout) {
      setTimeout(() => {
        test();
        done();
      }, timeout || 1);
    }

    describe('control-state behavior', function() {
      var customElement, focusElement;

      beforeEach(function(done) {
        customElement = fixture('default');

        // Need the shadow dom be rendered before getting the internal element reference
        runAsync(() => focusElement = customElement._getFocusElement(), done);
      });

      describe('tabindex', function() {
        if (!window.ShadyDOM) {
          it('in shadow dom setting tabIndex should update the attribute', function() {
            customElement.tabIndex = 1;
            expect(customElement.getAttribute('tabindex')).to.be.equal('1');
          });

          it('in shadow dom enabling the element should restore old tabindex', function() {
            customElement.tabIndex = 1;
            customElement.disabled = true;
            customElement.disabled = false;
            expect(customElement.getAttribute('tabindex')).to.be.equal('1');
          });
        }

        it('setting disabled to true should remove tabindex', function() {
          customElement.tabIndex = 1;
          customElement.disabled = true;
          expect(customElement.getAttribute('tabindex')).to.not.be.ok;
        });

        it('in disabled mode when tabindex is set, internal element should be updated', function(done) {
          customElement.tabIndex = 1;
          customElement.disabled = true;
          customElement.tabIndex = 4;
          // FF updates to attributes happen asynchronously
          runAsync(() =>expect(focusElement.getAttribute('tabindex')).to.be.equal('4'), done);
        });

        if (window.ShadyDOM) {
          it('in shady dom setting tabIndex should always set the attribute to -1', function(done) {
            customElement.tabIndex = 1;
            runAsync(() => expect(customElement.getAttribute('tabindex')).to.be.equal('-1'), done);
          });

          it('in shady dom setting tabIndex should forward it to the internal element', function(done) {
            customElement.tabIndex = 1;
            runAsync(() => expect(focusElement.getAttribute('tabindex')).to.be.equal('1'), done);
          });

          it('in shady dom setting disabled to false should restore tabIndex to -1', function(done) {
            customElement.disabled = true;
            customElement.tabIndex = 1;
            customElement.disabled = false;
            runAsync(() => expect(customElement.getAttribute('tabindex')).to.be.equal('-1'), done);
          });

          it('in shady dom tabindex should be set to the internal element', function(done) {
            customElement.tabIndex = 1;
            runAsync(() => expect(focusElement.getAttribute('tabindex')).to.be.equal('1'), done);
          });
        }
      });

      describe('focus', function() {
        it('should focus the internal input on focus', function() {
          // Avoid FF window focus issues by stubing native focus behavior
          window.sinon.stub(focusElement, 'focus', e => {
            focusElement.dispatchEvent(new CustomEvent('focus', {bubbles: true}));
          });

          customElement._focus();
          expect(customElement.focused).to.be.true;
        });

        it('should blur the internal input on blur', function() {
          window.sinon.stub(focusElement, 'focus', e => {
            focusElement.dispatchEvent(new CustomEvent('focus', {bubbles: true}));
          });
          window.sinon.stub(customElement.$.input, 'blur', e => {
            focusElement.dispatchEvent(new CustomEvent('blur', {bubbles: true}));
          });

          customElement._focus();
          customElement.blur();
          expect(customElement.focused).to.be.false;
        });
      });

    });
  </script>
</body>
