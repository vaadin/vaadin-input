<script>
  window.Vaadin = window.Vaadin || {};

  // Polymer.IronControlState is not a proper 2.0 class, also, its tabindex
  // implementation fails in the shadow dom, so we have this for vaadin elements.
  Vaadin.ControlStateMixin = subclass => class ControlStateMixin extends subclass {
    static get config() {
      return {
        properties: {
          /**
           * If true, the element currently has focus.
           */
          focused: {
            type: Boolean,
            value: false,
            notify: true,
            readOnly: true,
            observer: 'focusedChanged',
            reflectToAttribute: true
          },

          /**
           * If true, the user cannot interact with this element.
           */
          disabled: {
            type: Boolean,
            observer: '_disabledChanged',
            reflectToAttribute: true
          },

          /**
           * Internal property needed to listen to `tabindex` attribute changes.
           *
           * For changing the tabindex of this component use the native `tabIndex` propety.
           * @private
           */
          tabindex: {
            type: Number,
            observer: '_tabindexChanged'
          }
        }
      };
    }

    ready() {
      super.ready();

      // Make FF take the focus (#9)
      if (this.autofocus) {
        this.focus();
      }

      // In shadow dom, the element should be always focusable
      if (!window.ShadyDOM && this.getAttribute('tabindex') == null) {
        this._setTabindex(0);
      }

      this.addEventListener('focus', this.focus.bind(this));

      Polymer.RenderStatus.afterNextRender(this, () => {
        this.getFocusElement().addEventListener('focus', () => this._setFocused(true));
        this.getFocusElement().addEventListener('blur', () => this._setFocused(false));
        this.getFocusElement().addEventListener('keydown', e => {
          if (e.shiftKey && e.keyCode === 9) {
            this.focus();
          }
        });
      });
    }

    getFocusElement() {
      window.console.warn(`Please implement getFocusElement() in <${this.localName}>`);
      return this;
    }

    focus() {
      this.getFocusElement().focus();
    }

    blur() {
      this.getFocusElement().blur();
    }

    _disabledChanged(disabled) {
      this.getFocusElement().disabled = disabled;
      if (disabled) {
        this.blur();
        this._setTabindex(undefined);
      } else {
        this.tabIndex = this.getFocusElement().tabIndex;
      }
    }

    _tabindexChanged(tabindex) {
      if (!this._tabindexLocked) {
        this.getFocusElement().tabIndex = tabindex;
        if (this.disabled || window.ShadyDOM) {
          this._setTabindex(undefined);
        }
      }
    }

    _setTabindex(tabindex) {
      this._tabindexLocked = true;
      if (tabindex === undefined) {
        this.removeAttribute('tabindex');
      } else {
        this.setAttribute('tabindex', tabindex);
      }
      delete this._tabindexLocked;
    }

    focusedChanged() {
      // Needed for Edge, until they have support for CSS Custom Properties
      // (already shipping in Edge Preview)
      this.updateStyles();
    }
  };
</script>
