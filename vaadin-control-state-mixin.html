<script>

  // IronFormElementBehavior is not a proper 2.0 class, and its tabindex
  // implementation fails in the shadow dom.
  window.VaadinControlStateMixin = subclass => class extends subclass {
    static get config() {
      return {
        properties: {
          /**
           * If true, the element currently has focus.
           */
          focused: {
            type: Boolean,
            value: false,
            notify: true,
            readOnly: true,
            observer: '_focusedChanged',
            reflectToAttribute: true
          },

          /**
           * If true, the user cannot interact with this element.
           */
          disabled: {
            type: Boolean,
            observer: '_disabledChanged',
            reflectToAttribute: true
          },

          /**
           * Internal property needed to listen to `tabindex` attribute changes.
           *
           * For changing the tabindex of this component use the native `tabIndex` propety.
           * @private
           */
          tabindex: {
            type: Number,
            observer: '_tabindexChanged'
          }
        }
      };
    }

    ready() {
      super.ready();

      // Make FF take the focus (#9)
      if (this.autofocus) {
        this.focus();
      }

      this.addEventListener('focus', this._focus.bind(this));
      this.addEventListener('blur', this._blur.bind(this));

      Polymer.RenderStatus.afterNextRender(this, () => {
        this._getFocusElement().addEventListener('focus', this._onElemFocus.bind(this));
        this._getFocusElement().addEventListener('blur', this._onElemBlur.bind(this));
        this._getFocusElement().addEventListener('keydown', this._onElemKeydown.bind(this));
      });
    }

    _getFocusElement() {
      window.console.warn(`Please implement _getFocusElement() in <${this.localName}>`);
      return this;
    }

    _onElemFocus() {
      this._setFocused(true);
    }

    _focus() {
      this._getFocusElement().focus();
    }

    _onElemBlur() {
      this._setFocused(false);
      this.invalid = this._isInvalid();
    }

    _blur() {
      this._getFocusElement().blur();
    }

    _onElemKeydown(e) {
      // on shift-tab
      if (e.shiftKey && e.keyCode === 9) {
        this.focus();
      }
    }

    _disabledChanged(disabled) {
      if (disabled) {
        this._oldTabindex = this.tabindex;
        this.removeAttribute('tabindex');
      } else if (this._oldTabindex !== undefined) {
        this.tabIndex = this._oldTabindex;
        this._oldTabindex = undefined;
      }
    }

    _tabindexChanged(tabindex) {
      if (this.disabled && tabindex > 0) {
        this._oldTabindex = tabindex;
      }
      if (window.ShadyDOM && !this._tabindexChanging) {
        // In shady remove host attribute and set to internal input
        this._tabindexChanging = true;
        this.removeAttribute('tabindex');
        this._getFocusElement().tabIndex = tabindex;
        this._tabindexChanging = undefined;
      }
    }

    _focusedChanged() {
      // Needed for Edge, until they have support for CSS Custom Properties
      // (already shipping in Edge Preview)
      this.updateStyles();
    }
  };
</script>
